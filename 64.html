<html>

<head>
	<title>サイトマップ d3js</title>
	<meta content="">
</head>
<link rel="stylesheet" href="js/style.css">
<style>
	body {
		background-color: var(--c1);
		color: var(--c2);
		display: flex;
		/* justify-content: center; */
		flex-direction: column;
		align-items: center;
		padding: 0em;
		font-size: 1em;
		font-family: 'Franklin Gothic Medium', Arial, sans-serif;
	}

	h1 {
		font-size: 4em;
	}

	/* #chart {
		background-color: #ee5;
	} */

	.d3svg {
		background-color: #ffffff11;
	}

	.circle {
		background-color: blue;
		height: 100%;
		border-radius: 100%;
		text-align: center;
		line-height: 200px;
		font-size: 30px;
	}

	.circle span {
		line-height: normal;
		display: inline-block;
		vertical-align: middle;
		color: white;
		text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
	}

	.str {
		color: var(--c2)
	}
</style>

<body>
	<div id="i"></div>
	<h1>Site Map</h1>
	<div id="dev"></div>
	<div id="chart"></div>
</body>
<script src="js/d3v7.js"></script>
<script>
	const n = 200

	let dev = document.getElementById("dev")
	let i = document.getElementById("i")
	let str = window.location.href.split('/').pop();
	let num1 = parseInt(str.split(".")[0], 10) - 1 + ".html"
	let num2 = parseInt(str.split(".")[0], 10) + 1 + ".html"
	i.innerHTML = `<a href=\"${num1}\"><${num1}</a>` + " "
		+ `<a href=\"index.html\">Top</a>` + " "
		+ `<a href=\"${num2}\">${num2}></a>`

	let maxWidth = self.innerWidth
	let width = maxWidth * 0.9
	let height = self.innerHeight * 0.6
	function sort1(d, r) {
		return [-width / 2 + r + 2 * r * (d.name % 10),
		Math.floor(d.name / 10) * 2 * r + 150]
	}




	function d3main(json) {
		//設定
		const r = width / 10 / 2
		const cTimeScl = d3.scaleLinear()
			.domain([Math.min(...json.map((p) => p.ctime)), Math.max(...json.map((p) => p.ctime))])
			.range([0, 1]);

		const mTimeScl = d3.scaleLinear()
			.domain([Math.min(...json.map((p) => p.mtime)), Math.max(...json.map((p) => p.mtime))])
			.range([0, 1]);
		var c1 = d3.scaleSequential().domain([0, 2])
			.interpolator(d3.interpolateCubehelixDefault);
		var c2 = d3.scaleSequential().domain([0, 2])
			.interpolator(d3.interpolateBlues);


		//準備　svgタグ作成と座標変換
		const svg = d3.select("#chart").append("svg")
			.attr("class", "d3svg")
			.attr("width", maxWidth)
			.attr("height", n / 10 * r * 2)
			.attr(`viewbox`, `0 0 ${maxWidth} ${height}`)
		const flame = svg.append("g")
			.attr("transform", `translate(${maxWidth / 2},${2 * r})`)


		//描画
		const g = flame.selectAll("g").data(json).join("g")
			.attr("transform", (d, i) => {
				let x = 0
				let y = 0
				return `translate(${x},${y})`
			})//locale
			.append("a")
			.attr("href", (d, i) => d.name + ".html")

		const circle = g.append("circle")
			.attr("r", (d, i) => { return r })
			.attr("fill", (d, i) => {
				return c1(cTimeScl(d.ctime))
				// if (d.genre == "illust") { return "var(--c3)" }
				// if (d.genre == "font") { return "var(--c4)" }
				// if (d.genre == "") { return "var(--c6)" }
				// return "#886"
			}).attr("opacity", "0.6")

		const num = g.append("g").attr("transform", `translate(0,-30)`)
			.append("text")
			.text((d, i) => d.name)
			.attr("style", (d, i) => `font-size: ${2}em`)
			.attr("text-anchor", "middle")
			.attr("alignment-baseline", "central")
			.attr("fill", "var(--c2)")
		const title = g.append("g").attr("transform", `translate(0,-10)`)
			.append("foreignObject")
			.attr("x", -r * 0.7)
			.attr("y", "0")
			.attr("width", r * 2 * 0.7)
			.attr("height", r)
			.attr("class", "str")
			.attr("font-size", (d, i) => `${((0.2 * r / d.title.length) ** 0.1) * 0.8}em`)
			.attr("style", "text-align:center")
			.html((d, i) => d.title)

		g.on('mouseover', function (d, i) {
			d3.select(this).select("circle").attr("opacity", "0.4")
		})
			.on('mouseout', function (d, i) {
				d3.select(this).select("circle").attr("opacity", "0.6")
			})



		g.transition()
			.duration(700) // duration of the animation
			.delay(0) // delay animation start
			.attr("transform", (d, i) => {
				let sortX = sort1(d, r)[0]
				let sortY = sort1(d, r)[1]
				return `translate(${sortX},${sortY})`
			})
			.transition()
	}

	fetch("json/meta4.json")
		.then(response => { return response.json(); })
		.then(json => {
			d3main(json)
		})

</script>


</html>