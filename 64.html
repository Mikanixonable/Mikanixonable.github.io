<html>

<head>
  <title>illust index d3js</title>
  <meta content="">
</head>
<link rel="stylesheet" href="js/style.css">
<style>
  body {
    background-color: #1c1f1e;
    color: var(--c2);
    display: flex;
    /* justify-content: center; */
    flex-direction: column;
    align-items: center;
    padding: 0em;
    font-size: 1em;
    font-family: 'Franklin Gothic Medium', Arial, sans-serif;
  }

  h1 {
    font-size: 4em;
  }

  .str {
    color: var(--c2)
  }
</style>

<body>
  <div id="i"></div>
  <h1>illust index d3js</h1>
  <div id="dev"></div>
  <div id="chart"></div>
</body>
<script src="js/d3v7.js"></script>
<script type="text/javascript" src="js/svg-z-order.js"></script>
<script>
  //サイトマップに読み込むページのバックナンバーの上限
  const n = 800

  //前後ページへのリンク
  let dev = document.getElementById("dev")
  let i = document.getElementById("i")
  let str = window.location.href.split('/').pop();
  let num0 = parseInt(str.split(".")[0], 10)
  let num1 = parseInt(str.split(".")[0], 10) - 1
  let num2 = parseInt(str.split(".")[0], 10) + 1
  i.innerHTML = `<a href=\"${num1}\"><${num1}</a>` + " "
    + `<a href=\"index.html\">|${num0}|</a>` + " "
    + `<a href=\"${num2}\">${num2}></a>`

  let maxWidth = self.innerWidth * 0.95
  let width = maxWidth * 0.9
  let height = self.innerHeight * 0.6

  function sort1(d, r) {
    let d2 = d
    if (d == "index") { d2 = 0 }
    let dx = -width / 2 + r + 2 * r * (d2[d2.length - 1])
    // if(d2<0){dx =dx*-1-18*r}
    return [dx,
      Math.floor(d2 / 10) * 2 * r + 150]
  }

  //テーマに基づいて作品番号の配列をつくる
  function makeList(num) {
    list = [...Array(num)].map((_, i) => i)
    return list
  }

  //作品番号の配列を列ごとにグループ化した配列を作る
  function makeRow(list, width, thres) {
    let k = 0
    let arr = []
    let row = []
    for (const num in list) {
      row.push(String(num))
      k += 1
      if (k > thres - 1) {
        arr.push(row)
        row = []
        k = 0
      }
    }
    return arr
  }

  //グループ化した配列から画像の座標を計算し辞書に入れる
  function makeDic(json, arr, width) {
    let dic = []
    let heightsum = 0
    //一行単位の操作
    for (let k = 0; k < arr.length; k++) {
      let normalWidth = arr[k].reduce((sum, num) => {
        let img = json.find((v) => v.name == num)
        return sum + img["width"] / img["height"]
      }, 0)

      //一画像単位の操作
      let imgDic = {}
      let rate = 0
      let imgWidth
      let imgHeight = width / normalWidth
      heightsum += imgHeight
      for (let s = 0; s < arr[k].length; s++) {
        let image = json.find((v) => v.name == arr[k][s])
        imgDic = {}
        imgDic["name"] = image["name"]
        imgDic["title"] = image["title"]
        imgDic["tag"] = image["tag"]
        imgWidth = (image["width"] / image["height"]) * imgHeight
        imgDic["width"] = imgWidth
        imgDic["height"] = imgHeight

        rate = 0
        let img;
        for (let ss = 0; ss < s; ss++) {
          img = json.find((v) => v.name == arr[k][ss])
          rate += (img["width"] / img["height"]) / normalWidth
        }

        imgDic["x"] = (width * rate)
        imgDic["y"] = (heightsum - imgHeight)
        dic.push(imgDic)

      }
    }

    return dic
  }

  function make3(json, width, div, num) {
    let list = makeList(num)
    let arr = makeRow(list, width, div)
    let dic = makeDic(json, arr, width)
    return dic
  }
  // dev.innerHTML = makeRow(makeList(23),width,10)

  function d3main(json) {
    //設定
    const r = width / 10 / 2
    // const cTimeScl = d3.scaleLinear()
    //   .domain([Math.min(...json.map((p) => p.ctime)), Math.max(...json.map((p) => p.ctime))])
    //   .range([0, 1]);

    // const mTimeScl = d3.scaleLinear()
    //   .domain([Math.min(...json.map((p) => p.mtime)), Math.max(...json.map((p) => p.mtime))])
    //   .range([0, 1]);
    // var c1 = d3.scaleSequential().domain([-0.7, 2.8])
    //   .interpolator(d3.interpolateCubehelixDefault);
    // var c2 = d3.scaleSequential().domain([0, 2])
    //   .interpolator(d3.interpolateBlues);


    //準備　svgタグ作成と座標変換
    const svg = d3.select("#chart").append("svg")
      .attr("class", "d3svg")
      .attr("width", maxWidth)
      .attr("height", n / 10 * r * 2)
      .attr(`viewbox`, `0 0 ${maxWidth} ${height}`)
    const flame = svg.append("g")
      .attr("transform", `translate(${maxWidth / 2},${0})`)


    const gFlame = flame.append("g")
      .attr("transform", `translate(${-width / 2},${0})`)

    //描画
    let dic = make3(json, width, 7, 300)
    const g = gFlame.selectAll("g").data(dic).join("g")
      .attr("transform", (d, i) => {
        return `translate(${d.x},${d.y}) scale(${1})`
      })
    g.append("image")
      .attr("href", (d, i) => `illusts/s2/${d.name}.png`)
      .attr("height", (d, i) => {
        return d.height
      })

    //animation
    g.on('click', function (d, i) {
      //表示を最前面に
      let d3g = d3.select(this);
      svgz_element(d3g.node()).toTop();

      //画面中央に移動
      d3.select(this).transition().duration(150)
        .attr("transform", (di, ii) => {
          let r = Math.sqrt(di.width**2 + di.height**2)
          let x = width / 2 - height*di.width/(r*2)
          let y = window.scrollY - height*di.height/(r*2)
          return `translate(${x},${y}) scale(${1})`
        })
        d3.select(this).selectAll("image").transition().duration(150)
            .attr("height", (d,i)=>{
              let r = Math.sqrt(d.width**2 + d.height**2)
              let h = height*d.height/r
              return `${h}`
            })
    })

    // g.on('mouseover', function (d, i) {
    //   d3.select(this).transition().duration(150)
    //     .select("image").attr("height", (d_i, i_i) => {
    //       return d_i.height - d_i.height*0.02
    //     })
    //   d3.select(this).transition().duration(150)
    //   .attr("transform", (d_i, i_i) => {
    //     return `translate(${d_i.x + (d_i.width/d_i.height)*2},${d_i.y + d_i.height*0.01}) scale(${1})`
    //   })
    // })

    // g.on('mouseout', function (d, i) {
    //   d3.select(this).transition().duration(150)
    //     .select("image").attr("height", (d_i, i_i) => {
    //       return d_i.height
    //     })
    //   d3.select(this).transition().duration(150)
    //   .attr("transform", (d_i, i_i) => {
    //     return `translate(${d_i.x},${d_i.y }) scale(${1})`
    //   })
    // })



    //   d3.select(this).attr("transform", (d, i) => {
    //     return `translate(${0},${0}) scale(${1})`
    //   })
    // })

    //描画
    // const g = flame.selectAll("g").data(json).join("g")
    //   .attr("transform", (d, i) => {
    //     let x = sort1(d.name, r)[0]
    //     let y = sort1(d.name, r)[1]
    //     return `translate(${x},${y})`
    //   })//locale
    // // .append("a")
    // // .attr("href", (d, i) => d.name + ".html")

    // g.append("circle").attr("r", (d, i) => r)

    // const img = g.append("g").attr("transform", (d, i) => {
    //   let rate = d.height / d.width
    //   let x = -Math.sqrt(r ** 2 / (1 + rate ** 2))
    //   let y = x * rate
    //   return `translate(${x},${y})`
    // }).append("image")
    //   .attr("href", (d, i) => `illusts/s2/${d.name}.png`)
    //   .attr("height", (d, i) => {
    //     let rate = d.height / d.width
    //     let x = -Math.sqrt(r ** 2 / (1 + rate ** 2))
    //     let y = x * rate
    //     return -2 * y
    //   })

    // //labels
    // const num = g.append("g").attr("transform", `translate(0,-30)`)
    //   .append("text")
    //   .text((d, i) => d.name)
    //   .attr("style", (d, i) => `font-size: ${2}em`)
    //   .attr("text-anchor", "middle")
    //   .attr("alignment-baseline", "central")
    //   .attr("fill", "var(--c2)")
    // const title = g.append("g").attr("transform", `translate(0,-10)`)
    //   .append("foreignObject")
    //   .attr("x", -r * 0.7)
    //   .attr("y", "0")
    //   .attr("width", r * 2 * 0.7)
    //   .attr("height", r)
    //   .attr("class", "str")
    //   .attr("font-size", (d, i) => `${((0.2 * r / d.title.length) ** 0.1) * 0.8}em`)
    //   .attr("style", "text-align:center")
    //   .html((d, i) => d.title)







  }

  //main
  fetch("json/illusts.json")
    .then(response => { return response.json(); })
    .then(json => {
      d3main(json)
    })

</script>


</html>