<html>
<miku>
  <!--
   ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⢀⢀⠠⡠⠠⡠⡰⣒⢄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢌⢂⠢⡡⢑⠡⠪⡹⢮⢲⢱⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡔⡡⢘⠨⡂⢆⠢⡀⡯⣮⡪⢂⠕⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢐⢇⠧⣑⢄⠐⠈⠪⢢⡫⡟⠌⡂⡂⠢⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡸⡱⡡⢳⠠⠠⠀⡀⠕⢍⠀⠀⢐⠨⢐⢐⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠐⠌⢎⡂⠀⠉⣂⡕⠅⠕⠅⢁⠀⠐⡨⢐⢐⠨⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠅⠅⢅⠢⠀⢕⢗⢎⢎⠌⢀⠀⠠⠀⢂⢂⠢⠨⡈⠄⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⢡⢑⢐⢅⢐⠡⡃⡂⡑⡌⠄⠂⠂⠀⠐⡐⡡⢁⠢⠐⡀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⢨⢪⢢⡣⠧⢑⢼⡐⡅⢎⢾⢜⢶⠅⠀⠀⢱⢐⠡⠨⢐⠀⠄⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⡇⣗⢵⢙⠈⣔⠅⡏⡪⠘⠨⣻⢮⡂⠀⠀⠨⡪⡊⠌⡀⠂⠀⠄⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣜⢮⡺⣜⡀⡢⡳⡅⢌⢆⠁⠀⡯⣗⡇⠀⠀⠀⢹⡪⡀⠄⠂⠀⠀⠄⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠠⡸⡪⢣⢙⠜⡰⡹⢸⢪⠡⠪⡄⠀⣯⣳⢣⠀⠀⠀⠐⡝⡆⡂⢂⠈⢀⠠⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠠⢱⡁⠆⣇⢕⢕⢜⠮⡨⠂⢕⣕⢌⠢⣗⢗⢽⡀⠀⠀⠀⢣⡳⡨⢐⠨⠀⠄⠐⡀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠠⣑⢵⢕⡼⣾⣺⢾⣗⢅⠕⡱⠘⡜⣌⡮⣯⡇⡎⣇⠀⠀⠀⠨⣪⠢⡂⢊⠌⢂⠡⠐⠀⠀
  ⠀⠀⠀⠀⠀⠠⣑⡾⣝⡆⢟⢼⡺⡯⡯⣳⡐⣄⡧⡯⡗⡫⣷⣳⠱⡽⡀⠀⠀⠀⡣⡣⠊⠄⢌⠐⠌⠌⡂⠀
  ⠀⠀⠀⠀⡠⠡⡢⡻⡮⡏⡢⢇⢋⠯⠯⡪⢏⠳⡽⠰⢈⢸⣗⣗⢕⢝⣆⠀⠀⠀⢪⢪⠨⠨⠠⠡⠡⠡⠨⡀
  ⠀⠀⠀⡐⠄⢅⣗⢥⢪⣂⠄⡂⠄⠩⡈⠀⠁⠃⠅⢃⢢⠻⣺⡪⣎⢮⠳⠀⠀⠀⢂⠇⢌⠌⠌⠌⠌⠌⡂⡂
  ⠀⠀⡐⡐⢡⡳⣕⢧⡣⣯⣻⢺⣪⠢⠂⠀⠀⠘⡽⡽⣕⢧⠀⠂⠂⠁⠀⠀⠀⠀⢐⠅⠅⠌⠌⠌⠌⡂⡂⡂
  ⠀⢐⢐⢈⢲⢝⢮⡳⣕⣗⣗⢗⡗⢅⠀⠀⠀⠀⢹⣝⢮⣳⡀⠀⠀⠀⠀⠀⠀⠀⡐⠌⢜⠨⡊⠌⡂⡂⠢⠨
  ⠀⢂⢂⠢⢣⢫⡳⣝⢮⣞⣮⡳⡝⠄⠀⠀⠀⠀⠐⡽⣕⡷⡅⠀⠀⠀⠀⠀⠀⠀⢌⢜⢜⢜⢌⢂⠢⠨⠨⠨
  ⠈⠄⡂⢌⠪⡪⡪⡮⡳⣗⣗⢯⡇⡅⠀⠀⠀⠀⠀⢸⣗⢯⢯⠀⠀⠀⠀⠀⠀⠨⡐⡼⣕⢕⢕⠔⡡⠡⢁⠡
  ⠄⠁⡂⠢⡑⢌⢺⡪⣏⡷⣝⢗⡗⡕⠀⠀⠀⠀⠀⠈⡮⣏⢯⡂⠀⠀⠀⠀⠀⡪⢰⢣⡣⡣⡣⡊⠄⠂⠀⠀
  ⡂⡐⠌⡂⡊⠔⡵⡹⣜⣟⣮⡳⡑⠩⡀⠀⠀⠀⠀⠀⠹⣮⡳⣇⠀⠀⠀⠀⡨⡪⡪⡪⡪⡪⡪⢌⢪⠠⠁⠀
  ⢂⠔⠡⡂⡪⢨⢪⢪⣺⣟⡮⡇⠀⠀⠂⡀⠀⠀⠀⠀⠀⠳⣯⣻⣆⠀⠀⢀⣗⢝⣜⢮⡪⣪⢪⡪⡂⠇⠁⠀
  ⠐⡨⢸⢌⢆⢕⢕⣕⡯⣗⡯⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣾⢽⣆⠀⠐⡕⢕⢕⢧⡫⡮⡳⡑⠁⠀⠀⠀
  ⠀⠨⢪⢳⡱⡵⣕⠗⣯⣗⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣽⣺⠄⠀⠨⠈⢇⠧⡳⡹⠈⠀⠀⠀⠀⠀
  ⠀⠀⠈⠑⢝⢜⢘⠀⡷⣯⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⣞⣗⠀⠀⠈⠀⠅⠃⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠁⠂⠁⡯⣗⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢺⣝⠆⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⣯⠳⡅⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡪⢯⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⢮⡫⡪⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⢇⢇⢗⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠹⡎⠗⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⢕⢕⠳⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

-->
</miku>

<head>
  <title>月面植物園</title>
  <meta content="にそなのホームページ" genre="">
</head>
<link rel="stylesheet" href="js/style.css">
<style>
  body {
    background-color: var(--c1);
    color: var(--c2);
    display: flex;

    flex-direction: column;
    align-items: center;
    padding: 0em;
    font-size: 1em;
    font-family: monospace;
 
  }

  p {
    margin: 0;


  }

  foreignObject {
    display: flex;
    justify-content: center;
    flex-direction: column;
    align-items: center;
    padding: 0em;
    margin: 0em;
    /* text-anchor: middle; */
    /* text-align:end */
  }
</style>

<body id="body">
  <div id="chart"></div>
</body>

<script src="js/jquery.js"></script>
<script src="js/d3v7.js"></script>
<script>
  //リロード時に先頭へ移動
  $(function () {
    $('html,body').animate({ scrollTop: 0 }, '1');
  });

  //設定
  const width = window.innerWidth
  const height = window.innerHeight
  let n = 10 //分割数
  const unit = width / n
  let offset = 300
  const dice = offset + Math.floor(Math.random() * (534-offset) + 1)


  //実行
  fetch("json/illusts.json")
    .then(response => { return response.json(); })
    .then(json1 => {

      fetch("json/meta.json")
        .then(response => { return response.json(); })
        .then(json2 => {

          main(json1, json2)

        })
    })

  function main(json1, json2) {

    function whity(c) {
      let colrs = [c.slice(1, 3), c.slice(3, 5), c.slice(5, 7)]
        .map((v) => parseInt(v, 16) / 255)
      return (colrs[0] + colrs[1] + colrs[2]) / 3
    }
    let illust = json1.find((v) => v.num == String(dice))
  
    let clist = illust["colors"].sort((a, b) => {
      return whity(a) - whity(b)
    })

    function tile(dic) {
      //デフォルト値
      let dic2 = {
        "name": "name",
        "x": 0,
        "y": 0,
        "wh": [1, 1],
        "bgcolor": "var(--c5)",
      }
      //デフォルト値と入力値が違うときのみ上書き
      for (let key in dic) {
        dic2[key] = dic[key];
      }
      let a = svg.append("g")
        .attr("transform",
          `translate(${unit * dic2.x},${unit * dic2.y})`)

      if (dic2.url) {
        a = a.append("a").attr("href", dic2.url)
      }
      if (dic2.on) {
        a = a.on(dic2.on[0], dic2.on[1])
      }

      //文字ボックス
      a.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", unit * dic2.wh[0])
        .attr("height", unit * dic2.wh[1])
        .attr("fill", dic2.bgcolor)

      a
        .append("foreignObject")
        .attr("width", unit * dic2.wh[0])
        .attr("height", unit * dic2.wh[1])
        .attr("font-size", () => {
          let halfs = dic2.name.replace(/[^0-9a-z]/gi, '').length
          let fulls = dic2.name.length - halfs
          let letters = fulls + halfs * 0.5//半角文字を正規化した文字数

          let em = Math.min(
            dic2.wh[0] * unit / letters,//縦長の場合、幅が制限要素
            dic2.wh[1] * unit//横長の場合、高さが制限要素
          )

          let boxes = Math.floor(dic2.wh[0] / dic2.wh[1])
          if (boxes * 2 <= letters
            &&
            em * 5 < dic2.wh[1] * unit) {
            em *= 2
          }
          return em
        })

        .attr("color", () => {
          let bgcolor = dic2.bgcolor
          let color = "var(--c2)"
          if (whity(bgcolor) > 0.7) {
            color = clist[0]
          }
          return color
        })
        .html(dic2.name)
    }

    //svg要素作成
    const svg = d3.select("#chart").append("svg")
      .attr("width", width)
      .attr("height", height)

    //ヘッダ作成

    //ヘッダ背景
    svg.append("image")
      .attr("x", 0)
      .attr("y", 0)
      .attr("width", width)
      .attr("height", height)
      .attr("xlink:href", `illusts/${dice}.png`)

      .attr("preserveAspectRatio", "xMidYMin slice")

    //ヘッダ1 SNS

    //SNSリンク集
    const snsURLs = {
      "twitter": "https://twitter.com/Mikanixonable",
      "twitter2": "https://twitter.com/botseikatu",
      "twitter3": "https://twitter.com/Unicode_pod",
      "nisoho": "https://twitter.com/nisoho",
      "twitter4": "https://twitter.com/Eustralo",
      "discord": "https://discord.com/users/396122233698910218",
      "kakuyomu": "https://kakuyomu.jp/users/Eustralopithecus",
      "mstdn": "https://mstdn.jp/@Mikanixonable",
      "misskey": "https://misskey.io/@Mikanixonable",
      "pixiv": "https://www.pixiv.net/users/20149051/illustrations",
      "soundcloud": "https://soundcloud.com/mikanixonable",
      "keybase": "https://keybase.io/mikanixonable",
      "instagram": "https://www.instagram.com/mikanixonable/",
      "youtube": "https://www.youtube.com/channel/UCQ02LvaZAbZAgAWBN5pYniA",
      "github": "https://github.com/Mikanixonable",
      "spotify": "https://open.spotify.com/user/cjsdijim4zllci0624b1wbak2",
      "niconico": "https://www.nicovideo.jp/user/60514629/video",
      "vrchat": "https://vrchat.com/home/user/usr_37713f32-f424-4242-86c2-b8cb7bcc2b3b",
      "tiktok": "https://www.tiktok.com/@mikanixonable",
      "tumblr": "https://mikanixonable.tumblr.com/",
      "calckey": "https://calckey.jp/@Mikanixonable",
      "hatena": "https://mikanixonable.hatenablog.com/",
      "bookmeter": "https://bookmeter.com/users/1292458",

      "odaibako": "https://odaibako.net/u/Mikanixonable",



      "marshmallow": "https://marshmallow-qa.com/mikanixonable",
      "twicass": "https://twitcasting.tv/mikanixonable",
      "artstation": "https://www.artstation.com/mikanixonable",
      "niconicopic": "https://seiga.nicovideo.jp/user/illust/60514629",
      "peing": "https://peing.net/ja/mikanixonable",
      "askfm": "https://ask.fm/Mikanixonable",

    }

    const header = svg.append("g")
    //SNSリンクタイル作成関数定義

    function makeTile(sns, x, y, size) {
      header.append("a").attr("href", snsURLs[sns])
        .append("image")
        .attr("x", unit * x)
        .attr("y", unit * y)
        .attr("width", unit * size * 0.5)
        .attr("xlink:href", `icon/${sns}.png`)
    }
    //SNSリンク作成
    makeTile("twitter", 0, 0, 2)
    makeTile("twitter2", 4, 0.5, 0.5)
    makeTile("twitter3", 3, 0, 1)
    makeTile("twitter4", 4, 1, 0.06)
    makeTile("nisoho", 2.5, 0, 0.5)

    makeTile("kakuyomu", 2, 1, 1.5)
    makeTile("mstdn", 4, 1, 0.5)
    makeTile("calckey", 4, 2, 0.5)

    makeTile("discord", 5, 0, 1)

    makeTile("spotify", 7, 0, 1)
    makeTile("pixiv", 8, 0, 2)
    makeTile("tumblr", 7, 2, 2)
    makeTile("tiktok", 9, 2, 1)
    makeTile("niconico", 9, 3, 1)
    makeTile("vrchat", 6, 3, 1)
    makeTile("misskey", 5, 1, 2)
    makeTile("github", 7, 1, 1)

    makeTile("youtube", 0.5, 3, 1)
    makeTile("keybase", 3, 2.5, 1)
    makeTile("soundcloud", 2, 3, 1)
    makeTile("instagram", 1.5, 3, 0.5)
    makeTile("hatena", 0, 2, 1)

    makeTile("bookmeter", 6.5, 0, 0.5)
    makeTile("odaibako", 0, 3, 0.5)
    makeTile("artstation", 1.5, 2, 0.5)

    //タイトル


    tile({
      "x": 0,
      "y": 3.5,
      "wh": [5, 1.5],
      "name": "月面植物園",
      "bgcolor": clist[0],
    })
    tile({
      "x": 5,
      "y": 3.5,
      "wh": [2, 1.5],
      "name": "にそなのホームページ",
      "bgcolor": clist[0],
    })
    tile({
      "x": 7,
      "y": 3.5,
      "wh": [1, 2],
      "url": "5.html?n=" + dice,
      "name": "現在の背景画像",
      "bgcolor": clist[2],
    })
    tile({
      "x": 8,
      "y": 3.5,
      "wh": [2, 2],
      "url": "1.html",
      "name": "サイトマップ",
      "bgcolor": clist[3],
    })


    let news = json2.sort((a, b) => { return b.mtime - a.mtime })
    // .filter((v)=>!v.name.match(/_/))
    //開発中のhtmlファイル名はアンダーバーを含むため、除外


    tile({
      "x": 5,
      "y": 7,
      "wh": [3, 2],
      "name": "最近の更新",
      "bgcolor": illust.colors[4],
    })

    for (let k = 0; k < 10; k++) {
      tile({
        "x": 0,
        "y": 7 + k,
        "wh": [5, 1],
        "url": news[k].name + ".html",
        "name":
          news[k].name + " "
          + news[k].title
          + " " + news[k].mdate,
        "bgcolor": clist[k],
      })
    }
  

      function mikuButton(name,num, k){
        tile({
      "x": 0 + k,
      "y": 5.5,
      "wh": [1, 1],
      "name": name,
      "bgcolor": clist[k],
      "on": [
        "click",
        () => {
          let music = new Audio(num + '.mp3');
          music.currentTime = 0;
          music.play();
        }
      ]
    })
      }
      mikuButton("ミクボタン",1,0)
      mikuButton("ねう",2,1)
      mikuButton("Mazurek Dąbrowskiego",3,2)
      mikuButton("ねこーっ",4,3)
      mikuButton("ねこねこ",5,4)
      mikuButton("にゃう",6,5)
      mikuButton("ぬい~",7,6)
      // mikuButton("pikopiko",8,7)



  }
</script>

</html>