<html>

<head>
  <title>illust index d3js</title>
  <meta content="">
</head>
<link rel="stylesheet" href="js/style.css">
<style>
  body {
    background-color: var(--c7);
    color: var(--c2);
    display: flex;
    /* justify-content: center; */
    flex-direction: column;
    align-items: center;
    padding: 0em;
    font-size: 1em;
    font-family: 'Times New Roman', Times, serif;
  }

  h1 {
    font-size: 4em;
  }

  .str {
    color: var(--c2)
  }

</style>

<body>
<!-- 
  <h1>illust index d3js</h1>
  <div id="dev"></div> -->
  <div id="chart"></div>
</body>

<script src="js/d3v7.js"></script>
<!-- <script src="js/main.js"></script> -->
<!-- <script src="js/jquery.js"></script> -->
<script type="text/javascript" src="js/svg-z-order.js"></script>
<script>
  //サイトマップに読み込むページのバックナンバーの上限
  function main(json) {
    dic = make3(json, mainWidth, 7, 500)
    yList = dic.map(function (p) {
      return p.y;
    });
    let yMax = Math.max.apply(null, yList)
    let yMax2 = dic.find((p) => p.y == yMax).height
    pageHeight = yMax + yMax2


  }
  let n = 800
  let margin = 50
  let dev = document.getElementById("dev")
  let pageWidth = window.innerWidth
  let mainWidth = pageWidth - margin
  let viewHeight = window.innerHeight

  let dic
  let yList
  let pageHeight



  //テーマに基づいて作品番号の配列をつくる
  function makeList(num) {
    list = [...Array(num)].map((_, i) => i)
    return list
  }

  //作品番号の配列を列ごとにグループ化した配列を作る
  function makeRow(list, width, thres) {
    let k = 0
    let arr = []
    let row = []
    for (const num in list) {
      row.push(String(num))
      k += 1
      if (k > thres - 1) {
        arr.push(row)
        row = []
        k = 0
      }
    }
    return arr
  }

  //グループ化した配列から画像の座標を計算し辞書に入れる
  function makeDic(json, arr, width) {
    let dic = []
    let heightsum = 0
    //一行単位の操作
    for (let k = 0; k < arr.length; k++) {
      let normalWidth = arr[k].reduce((sum, num) => {
        let img = json.find((v) => v.name == num)
        return sum + img["width"] / img["height"]
      }, 0)

      //一画像単位の操作
      let imgDic = {}
      let rate = 0
      let imgWidth
      let imgHeight = width / normalWidth
      heightsum += imgHeight
      for (let s = 0; s < arr[k].length; s++) {
        let image = json.find((v) => v.name == arr[k][s])
        imgDic = {}
        imgDic["name"] = image["name"]
        imgDic["title"] = image["title"]
        imgDic["tag"] = image["tag"]
        imgWidth = (image["width"] / image["height"]) * imgHeight
        imgDic["width"] = imgWidth
        imgDic["height"] = imgHeight

        rate = 0
        let img;
        for (let ss = 0; ss < s; ss++) {
          img = json.find((v) => v.name == arr[k][ss])
          rate += (img["width"] / img["height"]) / normalWidth
        }

        imgDic["x"] = (width * rate)
        imgDic["y"] = (heightsum - imgHeight)
        dic.push(imgDic)

      }
    }

    return dic
  }
  //画像位置データ作成関数
  function make3(json, width, div, num) {
    let list = makeList(num)
    let arr = makeRow(list, width, div)
    let dic = makeDic(json, arr, width)
    return dic
  }

  //D3描画
  function d3main(json, dic) {

    //準備　svgタグ作成と座標変換
    let svg = d3.select("#chart").append("svg")
      .attr("class", "d3svg")
      .attr("width", pageWidth)
      .attr("height", pageHeight)
      .attr(`viewbox`, `0 0 ${pageWidth} ${pageHeight}`)
    let flame = svg.append("g")
      .attr("transform", `translate(${pageWidth / 2},${0})`)


    let gFlame = flame.append("g")
      .attr("transform", `translate(${-mainWidth / 2},${0})`)

    //描画

    let g = gFlame.selectAll("g").data(dic).join("g")
      .attr("transform", (d, i) => {
        return `translate(${d.x},${d.y}) scale(${1})`
      })
    const img = g.append("image").attr("class", "image")
      .attr("href", (d, i) => `illusts/s2/${d.name}.png`)
      .attr("height", (d, i) => {
        return d.height
      })

    //animation
    g.on('click', function (d, i) {

      //add rect
      let rect = gFlame.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", mainWidth)
        .attr("height", pageHeight)
        .attr("fill", "var(--c7)")
        .attr("opacity", 0.9)

      //選択解除時
      rect.on('click', function (d, i) {
        gFlame.selectAll("g")
          .attr("transform", (d, i) => {
            return `translate(${d.x},${d.y}) scale(${1})`
          })
        gFlame.selectAll("circle").remove()
        rect.remove()
        gFlame.selectAll(".preview").remove()
        gFlame.selectAll(".image")
          .attr("height", (d, i) => {
            return d.height
          })

      })

      //円を追加
      const backCircle = d3.select(this)
        .append("circle")
        .attr("cx", (d, i) => {
          let r = Math.sqrt(d.width ** 2 + d.height ** 2)
          return viewHeight * d.width / (r * 2)
        })
        .attr("cy", (d, i) => {
          let r = Math.sqrt(d.width ** 2 + d.height ** 2)
          return viewHeight * d.height / (r * 2)
        })
        .attr("r", (d, i) => {
          let r = viewHeight / 2
          return r
        })
        .attr("opacity", "0.7")

      //フルサイズ画像の表示
      d3.select(this).append("image").attr("class", "preview")
        .attr("href", (d, i) => `illusts/${d.name}.png`)
      .attr("height", (d, i) => {
        return d.height
      })


      //表示を最前面に
      let d3g = d3.select(this)
      svgz_element(d3g.node()).toTop();

      //gを画面中央に移動
      d3.select(this).transition().delay(0).duration(150)
        .attr("transform", (di, ii) => {
          let r = Math.sqrt(di.width ** 2 + di.height ** 2)
          let x = mainWidth / 2 - viewHeight * di.width / (r * 2)
          
          let h = viewHeight * di.height / r
          let y = window.scrollY+(viewHeight-h)/2 - 7.7
          return `translate(${x},${y}) scale(${1})`
        })
      //画像サイズ変更
      d3.select(this).selectAll("image").transition().delay(0).duration(150)
        .attr("height", (d, i) => {
          let r = Math.sqrt(d.width ** 2 + d.height ** 2)
          let h = viewHeight * d.height / r
          return `${h}`
        })

    })
  }

  //main
  fetch("json/illusts.json")
    .then(response => { return response.json(); })
    .then(json => {

      main(json)
      d3main(json, dic)

    })
</script>

</html>